---
# Install Neovim (Tool Layer - mise) and deploy configuration

- name: Load Neovim variables
  include_vars: "{{ role_path }}/tasks/tools/neovim/vars.yml"

- name: Install Neovim via mise
  args:
    creates: "{{ ansible_facts['env']['HOME'] }}/.local/share/mise/installs/neovim/{{ neovim_version }}"
  environment:
    PATH: "{{ ansible_facts['env']['HOME'] }}/.local/bin:{{ ansible_facts['env']['PATH'] }}"  # mise is installed in .local/bin
  shell: mise use -g neovim@{{ neovim_version }}

- name: Ensure Neovim config directory exists
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config"
    state: directory
    mode: '0755'

- name: Remove old nvim config if exists
  file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/nvim"
    state: absent

- name: Symlink Neovim configuration
  file:
    src: "{{ role_path }}/tasks/neovim/config/config"
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/nvim"
    state: link
    follow: no
    force: yes

- name: Install Neovim dependencies
  become: yes
  pacman:
    name:
      - xclip              # Clipboard support
      - wl-clipboard       # Wayland clipboard support
      - tree-sitter        # Tree-sitter CLI
    state: present

- name: Install stylua via mise
  args:
    creates: "{{ ansible_facts['env']['HOME'] }}/.local/share/mise/installs/stylua"
  environment:
    PATH: "{{ ansible_facts['env']['HOME'] }}/.local/bin:{{ ansible_facts['env']['PATH'] }}"  # mise is installed in .local/bin
  shell: mise use -g stylua@latest

- name: Display Neovim setup complete message
  debug:
    msg: |
      Neovim {{ neovim_version }} installed via mise (Tool Layer).
      - Pinned version for plugin stability
      - Update version: Edit roles/base/tasks/tools/neovim/vars.yml, then run bootstrap
      - Or manually upgrade via: mise use -g neovim@<version>
      - Run 'nvim' to trigger lazy.nvim plugin installation
      - stylua installed via mise (update with: mise upgrade stylua)
