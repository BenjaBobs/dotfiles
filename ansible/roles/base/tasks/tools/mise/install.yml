---
# Install mise (modern runtime version manager) - Tool Layer
# Installed via Cargo to enable self-update functionality

- name: Ensure Rust toolchain is installed
  become: yes
  pacman:
    name: rust
    state: present

- name: Install mise via Cargo
  args:
    creates: "{{ ansible_env.HOME }}/.cargo/bin/mise"
  environment:
    PATH: "{{ ansible_env.HOME }}/.cargo/bin:{{ ansible_env.PATH }}"
  shell: cargo install mise

- name: Ensure mise config directory exists
  file:
    path: "{{ ansible_env.HOME }}/.config/mise"
    state: directory
    mode: '0755'

- name: Add cargo bin to PATH in fish
  lineinfile:
    path: "{{ ansible_env.HOME }}/.config/fish/config.fish"
    line: "fish_add_path {{ ansible_env.HOME }}/.cargo/bin"
    create: yes
    state: present

- name: Enable mise in fish shell
  lineinfile:
    path: "{{ ansible_env.HOME }}/.config/fish/config.fish"
    line: "mise activate fish | source"
    state: present

- name: Display mise installation note
  debug:
    msg: |
      Mise installed via Cargo (Tool Layer).
      - Update with: mise self-update
      - Use 'mise use <tool>@<version>' to install runtimes
      - Example: mise use node@20, mise use python@3.12
      - Config: ~/.config/mise/config.toml or project-level .mise.toml
