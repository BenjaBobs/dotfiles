---
# KDE Plasma customization tasks

- name: Get current task manager configuration
  shell: |
    kreadconfig5 --file plasma-org.kde.plasma.desktop-appletsrc \
      --group "Containments" --group "2" --group "Applets" \
      --key "plugin" 2>/dev/null || echo "not found"
  register: taskmanager_check
  changed_when: false
  failed_when: false

- name: Configure KDE task manager pinned applications
  shell: |
    # Find the task manager applet ID
    APPLET_ID=$(kreadconfig5 --file plasma-org.kde.plasma.desktop-appletsrc \
      --list-groups | grep -m1 "Containments.*Applets" | grep -o "[0-9]*" | head -1)

    # Configure pinned applications in order: alacritty, vivaldi
    kwriteconfig5 --file plasma-org.kde.plasma.desktop-appletsrc \
      --group "Containments[2][Applets][$APPLET_ID][Configuration][General]" \
      --key "launchers" "applications:org.alacritty.Alacritty.desktop,applications:vivaldi-stable.desktop"
  register: kde_taskbar_config
  changed_when: true

- name: Restart plasmashell to apply changes
  when: kde_taskbar_config.changed
  shell: |
    killall plasmashell
    nohup plasmashell > /dev/null 2>&1 &
  async: 5
  poll: 0
  changed_when: false

- name: Display KDE customization note
  debug:
    msg: |
      KDE taskbar configured with pinned apps: Alacritty, Vivaldi
      - If changes don't appear, log out and back in
      - Or manually restart: killall plasmashell && plasmashell &
