---
# KDE Plasma customization tasks

- name: Install KDE configuration tools
  become: yes
  pacman:
    name:
      - kde-cli-tools     # Provides kwriteconfig5/kreadconfig5
    state: present

- name: Configure KDE task manager pinned applications
  shell: |
    # Determine which version of kwriteconfig to use
    if command -v kwriteconfig6 &> /dev/null; then
      KWRITE="kwriteconfig6"
      KREAD="kreadconfig6"
    elif command -v kwriteconfig5 &> /dev/null; then
      KWRITE="kwriteconfig5"
      KREAD="kreadconfig5"
    else
      echo "KDE config tools not found, skipping taskbar customization"
      exit 1
    fi

    CONFIG_FILE="$HOME/.config/plasma-org.kde.plasma.desktop-appletsrc"
    if [ ! -f "$CONFIG_FILE" ]; then
      echo "KDE config file not found, skipping taskbar customization"
      exit 1
    fi

    # Find the panel containment ID (plugin=org.kde.panel)
    PANEL_ID=$(awk '
      /^\[Containments\]\[[0-9]+\]$/ {match($0, /\[Containments\]\[([0-9]+)\]/, m); cid=m[1]; in_cont=1; next}
      /^\[/ {in_cont=0; next}
      in_cont && /^plugin=org\.kde\.panel$/ {print cid; exit}
    ' "$CONFIG_FILE")

    if [ -z "$PANEL_ID" ]; then
      echo "Panel containment not found, skipping taskbar customization"
      exit 1
    fi

    # Find all task manager applet IDs within the panel (plugin=org.kde.plasma.icontasks)
    APPLET_IDS=$(awk -v panel="$PANEL_ID" '
      $0 ~ "^\\[Containments\\]\\[" panel "\\]\\[Applets\\]\\[[0-9]+\\]$" {match($0, /\\[Applets\\]\\[([0-9]+)\\]/, m); app=m[1]; in_app=1; next}
      /^\[/ {in_app=0; next}
      in_app && /^plugin=org\.kde\.plasma\.icontasks$/ {print app}
    ' "$CONFIG_FILE")

    if [ -z "$APPLET_IDS" ]; then
      echo "Task manager applet not found, skipping taskbar customization"
      exit 1
    fi

    # Configure pinned applications in order: ghostty, vivaldi
    for APPLET_ID in $APPLET_IDS; do
      $KWRITE --file plasma-org.kde.plasma.desktop-appletsrc \
        --group "Containments[$PANEL_ID][Applets][$APPLET_ID][Configuration][General]" \
        --key "launchers" "applications:com.mitchellh.ghostty.desktop,applications:com.vivaldi.Vivaldi.desktop"
    done
  register: kde_taskbar_config
  changed_when: kde_taskbar_config.rc == 0
  failed_when: false

- name: Restart plasmashell to apply changes
  when: kde_taskbar_config.changed
  shell: |
    killall plasmashell
    nohup plasmashell > /dev/null 2>&1 &
  async: 5
  poll: 0
  changed_when: false

- name: Display KDE customization note
  debug:
    msg: |
      KDE taskbar configured with pinned apps: Ghostty, Vivaldi
      - Changes applied after plasmashell restart
      - If changes don't appear, log out and back in
